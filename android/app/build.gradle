plugins {
  id 'com.android.application'
  id 'org.jetbrains.kotlin.android'
  id 'com.facebook.react'
  id 'com.google.gms.google-services'
}

react {
  // RN autolink
  autolinkLibrariesWithApp()
}

android {
  namespace "com.finguard"

  // ✅ compileSdk를 최신 DSL로 명시
  compileSdk 35

  defaultConfig {
    applicationId "com.finguard"
    minSdk 24
    targetSdk 35
    versionCode 1
    versionName "1.0.0"
  }

  compileOptions {
    sourceCompatibility JavaVersion.VERSION_17
    targetCompatibility JavaVersion.VERSION_17
  }
  kotlinOptions {
    jvmTarget = "17"
  }

  buildTypes {
    debug { signingConfig signingConfigs.debug }
    release {
      minifyEnabled false
      shrinkResources false
      proguardFiles getDefaultProguardFile("proguard-android-optimize.txt"), "proguard-rules.pro"
    }
  }

  packaging {
    resources {
      pickFirsts += ["**/*.so", "META-INF/*"]
    }
  }
}

dependencies {

  implementation "com.facebook.react:react-android"

  def hermesEnabled = (project.findProperty("hermesEnabled") ?: "true").toBoolean()
  if (hermesEnabled) {
    implementation "com.facebook.react:hermes-android"
  } else {
    implementation "io.github.react-native-community:jsc-android:250230.2.1"
  }

  // 필요한 경우에만 추가
  implementation "com.google.android.gms:play-services-base:18.5.0"
  implementation "com.google.android.gms:play-services-location:21.2.0"
  implementation "com.google.firebase:firebase-messaging:23.4.0"
}

/** 오토링킹 입력 파일 생성 타이밍 보정 (CI/Windows 간헐 이슈 회피) */
def autolinkDir = file("$rootDir/build/generated/autolinking")
tasks.register("prepareAutolinkingDir") {
  doLast { if (!autolinkDir.exists()) autolinkDir.mkdirs() }
}
gradle.projectsEvaluated {
  def genJsonTask =
      tasks.findByName("generateAutolinkingJson") ?:
      tasks.findByName("generateAutolinking") ?:
      tasks.findByName("reactNativeConfig")

  def genNewArchTask = tasks.findByName("generateAutolinkingNewArchitectureFiles")

  if (genJsonTask) {
    genJsonTask.dependsOn("prepareAutolinkingDir")
  }
  if (genJsonTask && genNewArchTask) {
    genNewArchTask.mustRunAfter(genJsonTask)
    genNewArchTask.dependsOn(genJsonTask)
  }
}
